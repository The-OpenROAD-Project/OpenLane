OpenRAM macro usage guide in sky130
--------------------------------------------------------------------------------

Create a new design.

.. code-block:: console

    ./flow.tcl -design test_sram_macro -init_design_config -add_to_designs

Create blackbox declaration of ``sky130_sram_1kbyte_1rw1r_32x256_8``
in file ``designs/test_sram_macro/sky130_sram_1kbyte_1rw1r_32x256_8.bb.v``.
Copy the relevant sections from ``pdks/sky130B/libs.ref/sky130_sram_macros/verilog/sky130_sram_1kbyte_1rw1r_32x256_8.v``.

.. code-block:: verilog

    // OpenRAM SRAM model
    // Words: 256
    // Word size: 32
    // Write size: 8

    (*blackbox*)
    module sky130_sram_1kbyte_1rw1r_32x256_8(
    `ifdef USE_POWER_PINS
        vccd1,
        vssd1,
    `endif
    // Port 0: RW
        clk0,csb0,web0,wmask0,addr0,din0,dout0,
    // Port 1: R
        clk1,csb1,addr1,dout1
    );

    parameter NUM_WMASKS = 4 ;
    parameter DATA_WIDTH = 32 ;
    parameter ADDR_WIDTH = 8 ;
    parameter RAM_DEPTH = 1 << ADDR_WIDTH;
    // FIXME: This delay is arbitrary.
    parameter DELAY = 3 ;
    parameter VERBOSE = 1 ; //Set to 0 to only display warnings
    parameter T_HOLD = 1 ; //Delay to hold dout value after posedge. Value is arbitrary

    `ifdef USE_POWER_PINS
        inout vccd1;
        inout vssd1;
    `endif
    input  clk0; // clock
    input   csb0; // active low chip select
    input  web0; // active low write control
    input [NUM_WMASKS-1:0]   wmask0; // write mask
    input [ADDR_WIDTH-1:0]  addr0;
    input [DATA_WIDTH-1:0]  din0;
    output [DATA_WIDTH-1:0] dout0;
    input  clk1; // clock
    input   csb1; // active low chip select
    input [ADDR_WIDTH-1:0]  addr1;
    output [DATA_WIDTH-1:0] dout1;

    endmodule


.. todo:: Create the verilog file

Connect LEF files using ``EXTRA_LEFS``.
In this case absolute path is used, if the PDK location is different then path needs to be changed.
This files contains lightweight abstract representation of the cell.
LEF contains only metal layers and layers that can connect between cells (met1, via2, nwell, pwell, etc).

Connect GDS files with the subcomponent.
The GDS from ``EXTRA_GDS_FILES`` that will be used to generate the final GDS file.
For analog cells it is users responsibility to make sure that GDS matches LEF files.

Finally, connect the blackbox declaration verilog file using ``VERILOG_FILES_BLACKBOX``.

.. code-block:: json

    "EXTRA_LEFS":      "/openlane/pdks/sky130B/libs.ref/sky130_sram_macros/lef/sky130_sram_1kbyte_1rw1r_32x256_8.lef",
    "EXTRA_GDS_FILES": "/openlane/pdks/sky130B/libs.ref/sky130_sram_macros/gds/sky130_sram_1kbyte_1rw1r_32x256_8.gds",
    "VERILOG_FILES_BLACKBOX": "dir::sky130_sram_1kbyte_1rw1r_32x256_8.bb.v",


Set the following floorplan parameters:

.. code-block:: json

    "FP_SIZING": "absolute",
    "DIE_AREA": "0 0 750 1250",
    "PL_TARGET_DENSITY": 0.5,

``FP_SIZING`` is set to ``absolute`` and it will tell the floorplan to use ``DIE_AREA`` as final macro block's size.
The we set the ``DIE_AREA``. This value is carefully constructed.
If it is set to big value then you are going to have routing/placement/timing issues.
On the other hand setting the value too low will cause placement and routing congestion issues.

To obtain perfect ``DIE_AREA`` the 50% utilization was used,
then aspect ratio was manually adjusted to keep the utilization around 45% and the final density about 50%.

Create the power/ground nets.
First net in the list will be used for standard cell power connections.

.. code-block:: json

    "VDD_NETS": "vccd1",
    "GND_NETS": "vssd1",

If you need more power/ground nets add the nets to the list:

.. code-block:: json

    "VDD_NETS": "vccd1 vccd2",
    "GND_NETS": "vssd1 vssd2",

Alternatively use ``SYNTH_USE_PG_PINS_DEFINES`` to allow automatic parsing of the power/ground nets.

.. code-block:: json

    "SYNTH_USE_PG_PINS_DEFINES": "USE_POWER_PINS",
    

Add the PDN connections between sram cells and the power/ground nets.
Syntax: ``<instance_name> <vdd_net> <gnd_net> <vdd_pin> <gnd_pin>``.
More information is available in `configuration variables documentation <configuration>`_.
Each macro hook is separated using comma, for example:

.. code-block:: json

    "FP_PDN_MACRO_HOOKS": "submodule.sram0 vccd1 vssd1 vccd1 vssd1, submodule.sram1 vccd1 vssd1 vccd1 vssd1",

The instance names need to be fetched from synthesis netlist.
For this purpose run the design until synthesis stage using following command:

.. code-block:: console

    ./flow.tcl -design test_sram_macro -tag synthesis_only -to synthesis -overwrite

Open following file ``designs/test_sram_macro/runs/synthesis_only/results/synthesis/test_sram_macro.v``.


.. code-block:: verilog

    /* Generated by Yosys 0.12+45 (git sha1 UNKNOWN, gcc 8.3.1 -fPIC -Os) */

    module test_sram_macro(rst_n, clk, cs, we, addr, write_allow, datain, dataout);
    wire _000_;
    wire _001_;
    wire _002_;
    ...
    sky130_sram_1kbyte_1rw1r_32x256_8 \submodule.sram0  (
        .addr0(addr),
        ...
        .wmask0(write_allow[3:0])
    );
    sky130_sram_1kbyte_1rw1r_32x256_8 \submodule.sram1  (
        .addr0(addr),
        ...
        .wmask0(write_allow[7:4])
    );


If the cell is referenced in the submodule then it has the prefix with the submodule name and escaped slash ``\``.
As can be seen there is two cells ``sky130_sram_1kbyte_1rw1r_32x256_8`` with instance names ``\submodule.sram0``, ``\submodule.sram1``.
Directly copy the instance names without the prefix escape symbol: ``submodule.sram0``, ``submodule.sram1``, avoid guessing it.


Then the ``FP_PDN_MACRO_HOOKS`` will look like this (note that there is no backslash in front of the name):

.. code-block:: json

    "FP_PDN_MACRO_HOOKS": "submodule.sram0 vccd1 vssd1 vccd1 vssd1, submodule.sram1 vccd1 vssd1 vccd1 vssd1",


The cells need to be placed inside the ``DIE_AREA``,
however the automatic placement does not account the I/O placement when selecting sram placement.

It is causing the SRAM component to be placed on the edge of the macro.
As a result the I/O power usage is going to be increased,
because there is a long net that goes over subcomponent.

Instead choose the locations of these cells manually.
The size of the cells can be taken from the LEF file ``pdks/sky130B/libs.ref/sky130_sram_macros/lef/sky130_sram_1kbyte_1rw1r_32x256_8.lef``.
While it is not required to know the size of the cell,
it is useful to make sure that the subcomponents do not overlap.

For example:

.. code-block::

    UNITS
    DATABASE MICRONS 1000 ;
    END UNITS
    MACRO sky130_sram_1kbyte_1rw1r_32x256_8
    CLASS BLOCK ;
    SIZE 479.78 BY 397.5 ;
    SYMMETRY X Y R90 ;

To specify the cell placement create file ``designs/test_sram_macro/macro_placement.cfg``:

.. code-block::

    submodule.sram0 125 125 N
    submodule.sram1 125 700 S

The syntax is ``<instance name> <x> <y> <direction>``.
The instance name needs to be taken directly from synthesis netlist without escape symbol at the beggining.

Then modify the ``config.json`` to reference this file.

.. code-block:: json

    "MACRO_PLACEMENT_CFG": "dir::macro_placement.cfg",

.. todo:: Add pictures of the macro placement in floorplan


.. todo:: Add pictures of final result

.. todo:: Explain above

"MAGIC_DRC_USE_GDS": false

.. todo:: Explain above





    "RUN_KLAYOUT_XOR": false,
    "RUN_MAGIC_DRC": false

.. todo:: Explain above

./flow.tcl -design test_sram_macro -tag full_guide_use_deflef_drc -overwrite

.. todo:: Explain above

./flow.tcl -design test_sram_macro -tag full_guide -overwrite


.. todo:: Explain why the placement might fail (Because not enough space/ because too much space)
.. todo:: Explain the PDN connections
.. todo:: Explain the power pins/nets connections
