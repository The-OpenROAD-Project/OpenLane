# Designs, Their Configuration, useful utilties:


## Adding a design

To add a new design, the following command creates a configuration file for your design:

```bash
./flow.tcl -design <design_name> -init_design_config
```

This will create the following directory structure:

```bash
designs/<design_name>
├── config.tcl
```
In the configuration file, you should edit the required variables and the optional variables, if needed. Further information about the variables can be found [here][2]

Also, the <design_name> could be  replaced by the <design_directory>, which will allow you to run any design on your machine.

**Note: config.tcl is a global configuration for all PDKs. For more information about design configuration files please visit this [section](#configuration-files)**

It is recommended to place the design's verilog files in a `src` directory inside the design's folder as following:

```bash
designs/<design_name>
├── config.tcl
├── src
│   ├── design.v
```

However, you can point to the src files while initializing the design and they will be pointed to automatically in the configuration file and will also be automatically copied to the src directory creating the same structure shown above.

```bash
./flow.tcl -design <design_name> -init_design_config -src <list_verilog_files>
```

Optionally, you can specify the configuration file name (without the extension) by using:

```bash
./flow.tcl -design <design_name> -init_design_config -tag <config_name>
```

After adding the design, you can specify the design name using a `-design` argument:

```bash
./flow.tcl -design <design_name>
```

Finally, you can specify the configuration file (belonging to that design) the flow should use:

```bash
./flow.tcl -design <design_name> -config <config_name>
```


## Configuration files

For each design there is a global config.tcl and other config files one for each PDK:
```bash
designs/<design_name>
├── config.tcl
├── skywater-pdk_sky130_fd_sc_hs_config.tcl
├── skywater-pdk_sky130_fd_sc_hd_config.tcl
├── src
│   ├── design.v
```
The general rule generated by using -init_design_config when adding a design is that the global config.tcl should end with:
```tcl
set filename $::env(OPENLANE_ROOT)/designs/$::env(DESIGN_NAME)/$::env(PDK)_$::env(STD_CELL_LIBRARY)_config.tcl
if { [file exists $filename] == 1} {
	source $filename
}
```
This implies that if the (PDK)_(STD_CELL_LIBRARY)_config.tcl doesn't exist the flow would resume normally with only the global config.tcl.

This structure allows for storing the best configurations for a given design on all different PDKs and their STD_CELL_LIBRARYs. The best configuration for a given design differ from one PDK and STD_CELL_LIBRARY to another.
For this reason, upon installing a new PDK/STD_CELL_LIBRARY or a new design, an exploration should be run on different configuration parameters to reach the best configuration. The script that enables this is [here][1]. 
After running the exploration, you will find in the logs two .csv newly generated files: {tag}_{timestamp}.csv and {tag}_{timestamp}_best.csv. The configuration name reported in the _best.csv file contains the best added configurations to the current run of the given design using the specified PDK/STD_CELL_LIBRARY.

Two scripts were created for this purpose:
 - A script to create a new configuration file for a given (PDK, STD_CELL_LIBRARY) pair, or replicate the configuration of a (PDK, STD_CELL_LIBRARY) to another (PDK, STD_CELL_LIBRARY).
 - A script to update the configuration of a given (PDK, STD_CELL_LIBRARY) according to an exploration result provided by a {tag}_best.csv file.

### Replicate/Create Design Configs for a (PDK,STD_CELL_LIBRARY) Pair:

To run the script to create new (empty) configurations for a (PDK,STD_CELL_LIBRARY) pair:
```bash
    python3 ./scripts/replicateDesignsConfigs.py --to-pdk PDK --to-std-cell-lib STD_CELL_LIBRARY
```

To run the script to replicate configurations from one (PDK,STD_CELL_LIBRARY) pair to another:
```bash
    python3 ./scripts/replicateDesignsConfigs.py --from-pdk PDK_FROM --from-std-cell-lib STD_CELL_LIBRARY_FROM --to-pdk PDK --to-std-cell-lib STD_CELL_LIBRARY
```

The following is the list of flags used with the script:
<table>
    <tr>
        <th>
        Argument
        </th>
        <th >
        Description
        </th>
    </tr>
    <tr>
        <td align="center">
            <code>--designs | -d &lt;design1 design2 design3 ...&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Specifies the designs to create/replicate the configs for. same as -design argument in flow.tcl <br> Default is to update all designs under designs/
        </td>
    </tr>
    <tr>
        <td align="center">
            <code>--from-pdk | -fp &lt;PDK&gt;</code> <br> (Optional)
        </td>
        <td align="justify">
            The name of the PDK that the replicated design configuration belongs to. <br> if not specified along with from-std-cell-lib, the script will create a new configuration file for (pdkTo,to_std_cell_lib) that is empty.
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--from-std-cell-lib | -fscl &lt;STD_CELL_LIBRARY&gt;</code> <br> (Optional)
        </td>
        <td align="justify">
            The name of the STD_CELL_LIBRARY that the replicated design configuration belongs to. <br> if not specified along with from_std_cell_lib, the script will create a new configuration file for (pdkTo,to_std_cell_lib) that is empty.
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--to-pdk | -tp &lt;PDK&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            The name of the PDK that the created design configurations belongs to.
        </td>
    <tr>
        </tr>
        <td align="center">
            <code>--to-std-cell-lib | -tscl &lt;STD_CELL_LIBRARY&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            The name of the STD_CELL_LIBRARY that the created design configurations belongs to.
        </td>
    </tr>
</table>

### Update Design Configs for a (PDK,STD_CELL_LIBRARY) Pair after an Exploration:

To run the script to update configurations for a (PDK,STD_CELL_LIBRARY) pair after an exploration:
```bash
    python3 ./scripts/updateDesignsConfigs.py --pdk PDK --std-cell-lib STD_CELL_LIBRARY --best_results SW_exploration_best.csv
```

Check [this][1] for more details on the log files.

The following is the list of flags used with the script:
<table>
    <tr>
        <th>
        Argument
        </th>
        <th >
        Description
        </th>
    </tr>
    <tr>
        <td align="center">
            <code>--designs | -d &lt;design1 design2 design3 ...&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Specifies the designs to update the configs for. Same us -design in flow.tcl. <br> Default is to update all designs that exist in the given log file (_best.csv)
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--root | -r &lt;dirctory&gt; </code> <br> (Optional)
        </td>
        <td align="justify">
            Sets the root directory. The root should have the following folders under it: designs, logs, and scripts. <br> Default is the assumption that the script is called from the openlane root. 
        </td>
    </tr>
    <tr>
        <td align="center">
            <code>--pdk | -p &lt;PDK&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            The name of the PDK that the updated design(s) configuration belongs to.
        </td>
    </tr>
    <tr>
        </tr>
        <td align="center">
            <code>--std-cell-lib | -scl &lt;STD_CELL_LIBRARY&gt;</code> <br> (Optional)
        </td>
        <td align="justify">
            The name of the STD_CELL_LIBRARY that the updated design(s) configuration belongs to.
        </td>
    </tr>
      <tr>
        </tr>
        <td align="center">
            <code>--best_results | -b &lt;csv file&gt;</code> <br> (Required)
        </td>
        <td align="justify">
            This is the log file containing the best run for each design in a specific exploration. The log file will be used to determine the name of the configuration file to update from.
            The csv file provided must one occurance of each design.
            To tolerate custom log files, the script only exctracts the name of the design, its corresponding configuration file path, and whether the design passed or not by reading the runtime. If there were more than one occurance of the same design, the last occurance will override others. 
        </td>
    </tr>
      <tr>
        </tr>
        <td align="center">
            <code>--update_clock_period | -ucp</code> <br> (Boolean)
        </td>
        <td align="justify">
            Specifies whether or not to update the CLOCK_PERIOD of the design based on the suggested_clock_period parameter.<br> Default value: <code>False</code>
        </td>
    </tr>
      <tr>
        </tr>
        <td align="center">
            <code>--clean | -cl</code> <br> (Boolean)
        </td>
        <td align="justify">
            Specifies whether or not to delete the configuration file that the updated configuration file is updated from.<br> Default value: <code>False</code>
        </td>
    </tr>
</table>

**Note:** updateDesignsConfigs.py skips designs that fail during the exploration, which means their runtime will be `-1`.

**Important Note:** *The updateDesignsConfigs script only copies new configuration to the file. The new configurations are marked with a preceeding "# Regression" comment that is automatically written before them by the exploration script. However, the replicateDesignsConfigs copies the whole file.*

[1]: ../regression_results/README.md
[2]: ../configuration/README.md
